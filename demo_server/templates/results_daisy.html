{% extends "base_daisy.html" %}

{% block title %}Medical Report Results{% endblock %}

{% block content %}
<div class="flex flex-col">
    <!-- Streamlined results header -->
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-2xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-file-medical text-primary"></i>
                Medical Report Results
            </h2>
        </div>
        <div class="flex gap-2">
            <a href="{{ url_for('index') }}" class="btn btn-ghost btn-sm">
                <i class="fa-solid fa-arrow-left mr-2"></i> Back to Chat
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-primary btn-sm">
                <i class="fa-solid fa-plus mr-2"></i> New Report
            </a>
        </div>
    </div>

    <!-- Compact search and filter -->
    <div class="flex flex-col sm:flex-row gap-2 mb-3">
        <div class="form-control flex-grow">
            <div class="input-group input-group-sm">
                <input type="text" id="search-input" placeholder="Search results..." class="input input-bordered input-sm w-full" />
                <button class="btn btn-square btn-sm" id="search-button">
                    <i class="fa-solid fa-search"></i>
                </button>
            </div>
        </div>
        
        <div class="flex gap-2">
            <select class="select select-bordered select-sm" id="type-filter">
                <option value="all">All Types</option>
                <option value="process">Process</option>
                <option value="summary">Summary</option>
            </select>
            
            <select class="select select-bordered select-sm" id="date-filter">
                <option value="all">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
    </div>

    <!-- Responsive results table with cards for mobile -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-0">
            {% if results %}
            <!-- Desktop table view -->
            <div class="hidden md:block overflow-x-auto">
                <table class="table table-zebra table-sm">
                    <thead>
                        <tr>
                            <th class="w-10">
                                <label>
                                    <input type="checkbox" class="checkbox checkbox-sm" />
                                </label>
                            </th>
                            <th class="w-24">Type</th>
                            <th>Filename</th>
                            <th class="w-40">Created</th>
                            <th class="w-28">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="results-table-body-desktop">
                        {% for result in results %}
                        <tr class="hover result-row" data-filename="{{ result.filename }}" data-type="{{ result.type }}">
                            <th>
                                <label>
                                    <input type="checkbox" class="checkbox checkbox-sm" />
                                </label>
                            </th>
                            <td>
                                {% set is_summary = result.type == 'summary' or 'summarize' in result.filename.lower() %}
                                <div class="badge {% if not is_summary %}badge-primary{% else %}badge-accent{% endif %} badge-sm gap-1">
                                    <i class="fa-solid {% if not is_summary %}fa-microscope{% else %}fa-file-lines{% endif %}"></i>
                                    {% if is_summary %}Summary{% else %}Process{% endif %}
                                </div>
                            </td>
                            <td class="truncate max-w-xs">{{ result.filename }}</td>
                            <td>{{ result.created }}</td>
                            <td>
                                <div class="flex gap-1">
                                    <a href="{{ url_for('view_result', filename=result.filename) }}" class="btn btn-ghost btn-xs">
                                        <i class="fa-solid fa-eye"></i>
                                    </a>
                                    <a href="{{ url_for('download_result', filename=result.filename) }}" class="btn btn-ghost btn-xs">
                                        <i class="fa-solid fa-download"></i>
                                    </a>
                                    <button class="btn btn-ghost btn-xs text-error delete-btn" data-filename="{{ result.filename }}">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Mobile card view -->
            <div class="grid grid-cols-1 gap-2 p-2 md:hidden" id="results-table-body-mobile">
                {% for result in results %}
                <div class="card bg-base-200 shadow-sm hover:shadow result-card" data-filename="{{ result.filename }}" data-type="{{ result.type }}">
                    <div class="card-body p-3">
                        <div class="flex justify-between items-start">
                            {% set is_summary = result.type == 'summary' or 'summarize' in result.filename.lower() %}
                            <div class="badge {% if not is_summary %}badge-primary{% else %}badge-accent{% endif %} gap-1">
                                <i class="fa-solid {% if not is_summary %}fa-microscope{% else %}fa-file-lines{% endif %}"></i>
                                {% if is_summary %}Summary{% else %}Process{% endif %}
                            </div>
                            <div class="text-xs opacity-70">{{ result.created }}</div>
                        </div>
                        <h3 class="text-sm font-medium truncate">{{ result.filename }}</h3>
                        <div class="flex justify-end items-center mt-1">
                            <div class="card-actions">
                                <a href="{{ url_for('view_result', filename=result.filename) }}" class="btn btn-ghost btn-xs">
                                    <i class="fa-solid fa-eye"></i>
                                </a>
                                <a href="{{ url_for('download_result', filename=result.filename) }}" class="btn btn-ghost btn-xs">
                                    <i class="fa-solid fa-download"></i>
                                </a>
                                <button class="btn btn-ghost btn-xs text-error delete-btn" data-filename="{{ result.filename }}">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex flex-col items-center justify-center py-12">
                <div class="text-center">
                    <i class="fa-solid fa-folder-open text-5xl text-base-300 mb-4"></i>
                    <h3 class="text-lg font-semibold">No Results Found</h3>
                    <p class="text-base-content/70">Process a medical report to see results here.</p>
                    <a href="{{ url_for('index') }}" class="btn btn-primary mt-4">
                        <i class="fa-solid fa-plus mr-2"></i> Process New Report
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pagination -->
    {% if results and results|length > 10 %}
    <div class="flex justify-center mt-4">
        <div class="join">
            <button class="join-item btn btn-sm">«</button>
            <button class="join-item btn btn-sm">1</button>
            <button class="join-item btn btn-sm btn-active">2</button>
            <button class="join-item btn btn-sm">3</button>
            <button class="join-item btn btn-sm">»</button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Delete confirmation modal -->
<dialog id="delete-modal" class="modal">
    <form method="dialog" class="modal-box">
        <h3 class="font-bold text-lg">Confirm Deletion</h3>
        <p class="py-4">Are you sure you want to delete this result? This action cannot be undone.</p>
        <div class="modal-action">
            <button class="btn btn-ghost">Cancel</button>
            <button id="confirm-delete" class="btn btn-error">Delete</button>
        </div>
    </form>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Search functionality
        const searchInput = document.getElementById('search-input');
        const typeFilter = document.getElementById('type-filter');
        const dateFilter = document.getElementById('date-filter');
        const resultsTableBody = document.getElementById('results-table-body');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        
        let fileToDelete = null;
        
        // Filter results
        function filterResults() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeValue = typeFilter.value;
            const dateValue = dateFilter.value;
            
            // Filter desktop view
            const desktopRows = document.querySelectorAll('#results-table-body-desktop tr');
            desktopRows.forEach(row => {
                const filename = row.getAttribute('data-filename').toLowerCase();
                const type = row.getAttribute('data-type');
                
                const matchesSearch = filename.includes(searchTerm);
                const matchesType = typeValue === 'all' || type === typeValue;
                // Date filtering would be implemented here if needed
                const matchesDate = true; // For now, we'll just pass this
                
                if (matchesSearch && matchesType && matchesDate) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
            
            // Filter mobile view
            const mobileCards = document.querySelectorAll('#results-table-body-mobile .result-card');
            mobileCards.forEach(card => {
                const filename = card.getAttribute('data-filename').toLowerCase();
                const type = card.getAttribute('data-type');
                
                const matchesSearch = filename.includes(searchTerm);
                const matchesType = typeValue === 'all' || type === typeValue;
                // Date filtering would be implemented here if needed
                const matchesDate = true; // For now, we'll just pass this
                
                if (matchesSearch && matchesType && matchesDate) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });
        }
        
        // Add event listeners for filtering
        searchInput.addEventListener('input', filterResults);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                filterResults();
            }
        });
        
        // Add search button functionality
        document.getElementById('search-button').addEventListener('click', filterResults);
        
        // Add filter change listeners
        typeFilter.addEventListener('change', filterResults);
        dateFilter.addEventListener('change', filterResults);
        
        // Delete functionality
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                fileToDelete = this.getAttribute('data-filename');
                deleteModal.showModal();
            });
        });
        
        confirmDeleteBtn.addEventListener('click', function() {
            if (fileToDelete) {
                // Send delete request to the server
                fetch(`/delete_result/${fileToDelete}`, {
                    method: 'POST',
                })
                .then(response => {
                    if (response.ok) {
                        // Remove the row from the table
                        const desktopRow = document.querySelector(`#results-table-body-desktop tr[data-filename="${fileToDelete}"]`);
                        if (desktopRow) desktopRow.remove();
                        
                        // Remove the card from mobile view
                        const mobileCard = document.querySelector(`#results-table-body-mobile .result-card[data-filename="${fileToDelete}"]`);
                        if (mobileCard) mobileCard.remove();
                        
                        showToast(`File "${fileToDelete}" has been deleted`, 'success');
                        
                        // If no results left, reload the page to show empty state
                        const remainingItems = document.querySelectorAll('#results-table-body-desktop tr, #results-table-body-mobile .result-card');
                        if (remainingItems.length === 0) {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    } else {
                        showToast('Error deleting file', 'error');
                    }
                    fileToDelete = null;
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error deleting file', 'error');
                    fileToDelete = null;
                });
            }
        });
        
        // Make rows clickable to view result
        document.querySelectorAll('.result-row').forEach(row => {
            row.addEventListener('click', function(e) {
                // Don't navigate if clicking on a button
                if (e.target.closest('button') || e.target.closest('a') || e.target.closest('input')) {
                    return;
                }
                
                const filename = this.getAttribute('data-filename');
                window.location.href = `/view_result/${filename}`;
            });
        });
    });
</script>
{% endblock %}
